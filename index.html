<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Food Donation Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getDatabase, ref, set, get, onValue, update } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyChHUYTqCCmCHJOCd73tim5gV9PCqTyQ2o",
      authDomain: "food-donation-tracker-4084e.firebaseapp.com",
      databaseURL: "https://food-donation-tracker-4084e-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "food-donation-tracker-4084e",
      storageBucket: "food-donation-tracker-4084e.firebasestorage.app",
      messagingSenderId: "789282705882",
      appId: "1:789282705882:web:ed4410ce766855989730e3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const LOCATION_CAPACITY = 1000;
    const LOCATIONS = [
      "Pusat Transit Gelandangan Jalan Pahang",
      "Pusat Khidmat Gelandangan Medan Tuanku",
      "Pusat Pembelajaran Komuniti Jalan Chow Kit"
    ];

    const form = document.getElementById('donationForm');
    const donationList = document.getElementById('donationList');
    const filterLocation = document.getElementById('filterLocation');
    const locationSelect = document.getElementById('location');
    const editIndexInput = document.getElementById('editIndex');
    const locationChart = document.getElementById('locationChart');

    let donations = [];
    let lastResetDate = localStorage.getItem('lastResetDate');

    function resetDonationsIfNewDay() {
      const today = new Date().toISOString().split('T')[0]; // Get current date (YYYY-MM-DD)
      if (lastResetDate !== today) {
        donations = [];
        localStorage.setItem('donations', JSON.stringify(donations));
        localStorage.setItem('lastResetDate', today);
        return true;
      }
      return false;
    }

    function saveDonationsToFirebase() {
      LOCATIONS.forEach((loc) => {
        const locationRef = ref(db, `location_stats/${loc}`);
        get(locationRef).then(snapshot => {
          let currentQuantity = snapshot.exists() ? snapshot.val().quantity : 0;
          const totalQuantity = currentQuantity + donations.reduce((sum, d) => {
            if (d.location === loc) {
              return sum + parseInt(d.quantity);
            }
            return sum;
          }, 0);

          if (totalQuantity <= LOCATION_CAPACITY) {
            const newDonationRef = ref(db, 'donations/' + Date.now());
            set(newDonationRef, donations);
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Full Capacity!',
              text: 'This location cannot accept more donations.'
            });
          }
        });
      });
    }

    function updateDashboard() {
      const locationStatsRef = ref(db, 'location_stats');
      onValue(locationStatsRef, (snapshot) => {
        if (snapshot.exists()) {
          const data = snapshot.val();
          // Update location stats dashboard
          document.getElementById('totalDonations').textContent = data.length;
          document.getElementById('totalQuantity').textContent = totalQuantity;
          let statsList = document.getElementById('locationStats');
          statsList.innerHTML = '';
          for (const [loc, qty] of Object.entries(data)) {
            const li = document.createElement('li');
            li.textContent = `${loc}: ${qty} / ${LOCATION_CAPACITY}`;
            statsList.appendChild(li);
          }
          drawChart(data);
        }
      });
    }

    function drawChart(data) {
      const labels = Object.keys(data);
      const quantityData = Object.values(data).map((value) => value.quantity);
      const ctx = locationChart.getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Quantity Donated',
            data: quantityData,
            backgroundColor: 'rgba(54, 162, 235, 0.7)',
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              max: LOCATION_CAPACITY
            }
          }
        }
      });
    }

    form.addEventListener('submit', function (e) {
      e.preventDefault();

      const location = document.getElementById('location').value;
      const quantity = parseInt(document.getElementById('quantity').value);
      const locStats = getLocationStats();
      const currentQty = 0;

      const newDonation = {
        donor: document.getElementById('donor').value,
        food: document.getElementById('food').value,
        quantity,
        date: document.getElementById('date').value,
        location
      };

      saveDonationToFirebase(newDonation);
      updateDashboard();

      Swal.fire({
        icon: 'success',
        title: 'Donation Saved!',
        timer: 1500,
        showConfirmButton: false
      });
    });

    function getLocationStats() {
      const stats = {};
      LOCATIONS.forEach(loc => stats[loc] = 0);
      donations.forEach(d => {
        if (stats[d.location] !== undefined) {
          stats[d.location] += parseInt(d.quantity);
        }
      });
      return stats;
    }

    window.addEventListener('DOMContentLoaded', () => {
      resetDonationsIfNewDay();
      renderDonations();
    });
  </script>
</body>
</html>
